<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rebalance</title>
    <style>
        /* ****** 輕柔 Neumorphism 變量 (Soft White & Blue Highlight) ****** */
        :root {
            /* 主體顏色與光暈 (柔和白) */
            --bg-color: #ECF0F3; 
            --main-color: #ECF0F3; 
            --text-primary: #333333;
            --text-secondary: #9AA4AE;

            /* 強調色 */
            --highlight-color: #635AF0; 
            --highlight-light: #9A87FF; 
            --highlight-text: #FFFFFF;

            /* Neumorphism 陰影 (柔和光暈感) */
            --shadow-light: 10px 10px 20px rgba(174, 174, 192, 0.4), -10px -10px 20px #FFFFFF;
            --shadow-small: 5px 5px 10px rgba(174, 174, 192, 0.3), -5px -5px 10px #FFFFFF;
            --inner-shadow-light: inset 5px 5px 10px rgba(174, 174, 192, 0.4), inset -5px -5px 10px #FFFFFF;

            /* Slider 陰影 */
            --thumb-shadow: 0 5px 15px rgba(174, 174, 192, 0.6), -5px -5px 10px #FFFFFF; 

            /* LCD 顯示屏 */
            --screen-bg: #F0F4F7; 
            --screen-text: var(--highlight-color); 
            --screen-label: var(--text-secondary); 

            /* 按鈕與活躍色 */
            --btn-control-color: var(--main-color);
            --btn-calc-color: var(--highlight-color); 
            --btn-calc-shadow: 0 5px 15px rgba(76, 114, 176, 0.4); 
            --active-color: var(--highlight-light); 
            
            /* 狀態顏色 */
            --status-ok-border: var(--highlight-color);
            --status-warn-border: #CC0000;
            --action-border: #9AA4AE;
            --dca-border: var(--highlight-color);

            /* Slider 顏色 */
            --slider-thumb-size: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); 
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 0;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            background: var(--main-color);
            padding: 25px 30px 40px;
            border-radius: 30px; 
            box-shadow: var(--shadow-light); 
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            z-index: 1;
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
            text-align: center;
        }
        
        .screen-display {
            background-color: var(--screen-bg);
            color: var(--screen-text);
            padding: 20px 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--inner-shadow-light);
            font-family: sans-serif;
            text-align: center;
            border: none;
        }
        .screen-display .main-value {
            font-size: 2.8rem;
            font-weight: 700;
            line-height: 1.1;
            margin: 0 0 5px 0;
            color: var(--screen-text);
        }
        .screen-display .label {
            font-size: 0.85rem;
            color: var(--screen-label);
            display: block;
            margin-bottom: 15px;
        }
        .screen-display .sub-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--screen-label);
            font-weight: 500;
        }
        .screen-display .percentage {
             font-size: 1.4rem;
             color: var(--screen-text);
             font-weight: 700;
        }

        /* ------------------------------------- */
        /* 輸入框組件 (資產名稱與市值) */
        /* ------------------------------------- */
        .input-item label, .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .asset-input {
            border-radius: 15px;
            box-shadow: var(--inner-shadow-light);
            background-color: var(--screen-bg);
            height: 50px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .asset-input input {
            padding: 12px 15px;
            border: none;
            background: none;
            color: var(--text-primary);
            outline: none;
            box-shadow: none;
            margin-bottom: 0;
            height: 100%;
            text-align: center;
        }

        .asset-input input[type="text"] {
            width: 50%;
            font-size: 1.05rem;
            border-right: 1px solid #D9DEE3;
            font-weight: 600;
        }

        .asset-input input[type="number"] {
            width: 50%;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--highlight-color);
        }
        
        /* ------------------------------------- */
        /* 月供滑桿 (Slider) 樣式 */
        /* ------------------------------------- */

        .slider-group {
            margin-bottom: 25px;
            text-align: center;
        }

        .dca-value-display {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--highlight-color);
            margin-bottom: 15px;
            display: block;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px; 
            background: transparent;
            margin: 10px 0;
        }

        /* 軌道 Track (凹陷效果) */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 10px;
            border-radius: 5px;
            background: var(--main-color);
            box-shadow: var(--inner-shadow-light); 
            border: none;
        }
        input[type="range"]::-moz-range-track {
            height: 10px;
            border-radius: 5px;
            background: var(--main-color);
            box-shadow: var(--inner-shadow-light); 
            border: none;
        }

        /* 圓形控制點 Thumb (純白 + 加強陰影) */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: var(--slider-thumb-size);
            width: var(--slider-thumb-size);
            border-radius: 50%;
            background: var(--main-color); 
            margin-top: calc((var(--slider-thumb-size) - 10px) / -2); 
            box-shadow: var(--thumb-shadow); 
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* 按下時 (Active state) - 凹陷效果 */
        input[type="range"]:active::-webkit-slider-thumb {
            box-shadow: var(--inner-shadow-light); 
            transform: scale(0.95);
        }

        /* Firefox 兼容性設置 */
        input[type="range"]::-moz-range-thumb {
            height: var(--slider-thumb-size);
            width: var(--slider-thumb-size);
            border-radius: 50%;
            background: var(--main-color);
            box-shadow: var(--thumb-shadow); 
            cursor: pointer;
            border: none; 
        }

        /* ------------------------------------- */
        /* 主要計算按鈕 */
        /* ------------------------------------- */
        .config-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            margin-bottom: 30px;
        }
        .config-buttons button {
            padding: 15px 10px;
            border: none;
            border-radius: 20px; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease; 
            color: var(--text-primary);
            background: var(--btn-control-color); 
            box-shadow: var(--shadow-small);
            border: none;
        }
        .config-buttons button.active {
            background-color: var(--active-color);
            color: var(--highlight-text);
            box-shadow: var(--inner-shadow-light); 
            transform: scale(0.98);
        }
        
        button#calculate-btn {
            width: 100%;
            padding: 20px;
            background-color: var(--btn-calc-color);
            color: var(--highlight-text);
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            margin-top: 25px;
            box-shadow: var(--btn-calc-shadow);
            transition: all 0.2s ease;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }
        button#calculate-btn:active {
            box-shadow: inset 3px 3px 7px rgba(0, 0, 0, 0.3), inset -3px -3px 7px var(--highlight-light);
            transform: translateY(1px);
        }

        /* ------------------------------------- */
        /* 結果展示 (卡片與表格) - 圓角修正區域 */
        /* ------------------------------------- */
        .result-panel {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #D9DEE3;
            display: none; 
            animation: fadeInSlide 0.6s ease-out forwards; 
        }

        .summary-table {
            border-collapse: separate; /* 確保 border-radius 生效 */
            border-spacing: 0; /* 移除間隔 */
            width: 100%;
            border-radius: 20px;
            box-shadow: var(--shadow-small);
            background-color: var(--main-color);
            overflow: hidden; /* 隱藏子元素溢出，確保圓角顯示 */
        }
        .summary-table th, .summary-table td {
            text-align: left;
            padding: 15px;
            font-size: 0.95rem;
            background-color: var(--main-color);
            
            /* ****** 修正點 1: 移除單元格底線，改為只用輕微的內邊線分隔 ****** */
            border-bottom: 1px solid #D9DEE3; 
            /* *************************************************************** */
        }
        
        .summary-table th {
            background-color: var(--screen-bg);
            color: var(--text-primary);
            font-weight: 600;
        }

        /* ****** 修正點 2: 處理邊角圓角 ****** */
        .summary-table thead tr:first-child th:first-child {
            border-top-left-radius: 20px;
        }
        .summary-table thead tr:first-child th:last-child {
            border-top-right-radius: 20px;
        }

        /* 確保表格尾部單元格沒有底邊線，並帶有圓角 */
        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }
        .summary-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 20px;
        }
        .summary-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 20px;
        }
        /* ************************************ */
        
        .status-box, .action-steps, .dca-advice {
            border-radius: 15px;
            margin-top: 20px;
            padding: 18px;
            font-weight: 500;
            background-color: var(--main-color);
            box-shadow: var(--shadow-small); 
            border: none;
            font-size: 0.95rem;
        }
        .status-box strong, .dca-advice strong {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .status-ok { 
            border-left: 6px solid var(--status-ok-border);
        }
        .status-warn { 
            color: var(--status-warn-border);
            border-left: 6px solid var(--status-warn-border); 
        }
        .action-steps { 
            border-left: 6px solid var(--action-border);
        }
        .dca-advice { 
            border-left: 6px solid var(--dca-border);
        }

        @keyframes fadeInSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>投資組合再平衡</h2>
    
    <div id="top-display" class="screen-display">
        <span class="label">當前總資產 (K 美元) / 核心資產目標比例</span>
        <div class="main-value" id="resTotalDisplay">0.00</div>
        <div class="sub-info">
            <span>核心資產 (<span id="resAssetNameA_short">A</span>) 比例:</span> 
            <span class="percentage" id="resAssetAPctDisplay">0.00%</span>
        </div>
    </div>

    <div class="input-group">
        <label>設定目標比例 (核心 / 衛星)</label>
        <div class="config-buttons">
            <button id="btn-80-20" class="active" onclick="setTarget(80, 20)">80% / 20%</button>
            <button id="btn-70-30" onclick="setTarget(70, 30)">70% / 30%</button>
            <button id="btn-60-40" onclick="setTarget(60, 40)">60% / 40%</button>
            <button id="btn-50-50" onclick="setTarget(50, 50)">50% / 50%</button>
        </div>
    </div>
    
    <div class="input-item">
        <label for="assetAName">核心資產名稱與市值 (K 美元)</label>
        <div class="asset-input">
            <input type="text" id="assetAName" value="QQQ" placeholder="資產代號">
            <input type="number" id="assetAVal" value="8.50" placeholder="市值">
        </div>
    </div>

    <div class="input-item">
        <label for="assetBName">衛星資產名稱與市值 (K 美元)</label>
        <div class="asset-input">
            <input type="text" id="assetBName" value="BND" placeholder="資產代號">
            <input type="number" id="assetBVal" value="1.50" placeholder="市值">
        </div>
    </div>

    <div class="input-group slider-group">
        <label for="dcaAmountSlider">每月供款金額 (K 美元)</label>
        <span id="dcaAmountDisplay" class="dca-value-display">0.50 K USD</span> 
        <input 
            type="range" 
            id="dcaAmountSlider" 
            min="0" 
            max="10" 
            step="0.05" 
            value="0.50" 
            oninput="updateDCA(this.value); calculate();"
        >
    </div>
    <button id="calculate-btn" onclick="calculate()">執行評估</button>

    <div id="resultPanel" class="result-panel">
        <h3 style="font-size: 1.3rem; margin-top: 0; color: var(--text-primary);">組合狀況概要</h3>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>資產</th>
                    <th>市值 (K 美元)</th>
                    <th>比例</th>
                    <th>目標比例</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="resAssetNameA">QQQ</td>
                    <td id="resAssetAVal">-</td>
                    <td id="resAssetAPct">-</td>
                    <td id="resTargetA">80%</td>
                </tr>
                <tr>
                    <td id="resAssetNameB">BND</td>
                    <td id="resAssetBVal">-</td>
                    <td id="resAssetBPct">-</td>
                    <td id="resTargetB">20%</td>
                </tr>
                <tr>
                    <td style="font-weight: 700;">總資產</td>
                    <td id="resTotal" colspan="3" style="font-weight: 700;">-</td>
                </tr>
            </tbody>
        </table>

        <div id="statusBox" class="status-box"></div>
        <div id="actionSteps" class="action-steps" style="display:none;"></div>
        <div id="dcaAdvice" class="dca-advice"></div>
    </div>
    
</div>

<script>
    // JavaScript 邏輯保持不變
    let targetA_pct = 80;
    let targetB_pct = 20;
    const REBALANCE_TOLERANCE = 5; 

    // 滑桿數值實時更新，並觸發計算
    function updateDCA(value) {
        document.getElementById('dcaAmountDisplay').innerText = `${parseFloat(value).toFixed(2)} K USD`;
    }

    function setTarget(A, B) {
        targetA_pct = A;
        targetB_pct = B;
        
        document.getElementById('btn-80-20').classList.toggle('active', A === 80);
        document.getElementById('btn-70-30').classList.toggle('active', A === 70);
        document.getElementById('btn-60-40').classList.toggle('active', A === 60);
        document.getElementById('btn-50-50').classList.toggle('active', A === 50);

        document.getElementById('resTargetA').innerText = `${targetA_pct}%`;
        document.getElementById('resTargetB').innerText = `${targetB_pct}%`;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const assetAName = document.getElementById('assetAName').value.toUpperCase().trim() || 'Asset A';
        const assetBName = document.getElementById('assetBName').value.toUpperCase().trim() || 'Asset B';
        document.getElementById('resAssetNameA_short').innerText = assetAName;
        document.getElementById('resAssetNameA').innerText = assetAName;
        document.getElementById('resAssetNameB').innerText = assetBName;

        setTarget(80, 20);
        document.getElementById('resTotalDisplay').innerText = '0.00';
        document.getElementById('resAssetAPctDisplay').innerText = '0.00%';
        
        const initialDCA = document.getElementById('dcaAmountSlider').value;
        updateDCA(initialDCA); 

        calculate();
    });

    function calculate() {
        const assetAName = document.getElementById('assetAName').value.toUpperCase().trim() || 'Asset A';
        const assetBName = document.getElementById('assetBName').value.toUpperCase().trim() || 'Asset B';
        
        const assetAVal = parseFloat(document.getElementById('assetAVal').value) || 0;
        const assetBVal = parseFloat(document.getElementById('assetBVal').value) || 0;
        const dcaAmount = parseFloat(document.getElementById('dcaAmountSlider').value) || 0;
        
        const totalVal = assetAVal + assetBVal;

        if (totalVal <= 0) {
            document.getElementById('resTotalDisplay').innerText = 'ERROR';
            document.getElementById('resAssetAPctDisplay').innerText = 'N/A';
            document.getElementById('resultPanel').style.display = "none";
            return;
        }

        const minA = targetA_pct - REBALANCE_TOLERANCE;
        const maxA = targetA_pct + REBALANCE_TOLERANCE;
        
        // 更新 UI 標籤與結果欄位
        document.getElementById('resAssetNameA').innerText = assetAName;
        document.getElementById('resAssetNameA_short').innerText = assetAName;
        document.getElementById('resAssetNameB').innerText = assetBName;
        document.getElementById('resTargetA').innerText = `${targetA_pct}%`;
        document.getElementById('resTargetB').innerText = `${targetB_pct}%`;

        const assetAPct = (assetAVal / totalVal) * 100;
        const assetBPct = 100 - assetAPct;
        
        // 輸出結果格式
        document.getElementById('resAssetAVal').innerText = `${assetAVal.toFixed(2)} K USD`;
        document.getElementById('resAssetAPct').innerText = `${assetAPct.toFixed(2)}%`;
        document.getElementById('resAssetBVal').innerText = `${assetBVal.toFixed(2)} K USD`;
        document.getElementById('resAssetBPct').innerText = `${assetBPct.toFixed(2)}%`;
        document.getElementById('resTotal').innerText = `${totalVal.toFixed(2)} K USD`;

        // 更新頂部儀表盤
        document.getElementById('resTotalDisplay').innerText = `${totalVal.toFixed(2)}`;
        document.getElementById('resAssetAPctDisplay').innerText = `${assetAPct.toFixed(2)}%`;


        // ********** 動畫邏輯更新 **********
        const resultPanel = document.getElementById('resultPanel');
        resultPanel.style.display = "none"; 
        void resultPanel.offsetWidth; 
        resultPanel.style.display = "block"; 
        // **********************************

        const statusBox = document.getElementById('statusBox');
        const actionSteps = document.getElementById('actionSteps');
        const dcaAdvice = document.getElementById('dcaAdvice');
        
        let needsRebalance = false;
        let message = "";
        
        if (assetAPct > maxA) {
            needsRebalance = true;
            message = ` **比例警告** ${assetAName} 佔比嚴重過高 (${assetAPct.toFixed(2)}% > ${maxA}%)，建議立即再平衡。`;
            statusBox.className = "status-box status-warn";
        } else if (assetAPct < minA) {
            needsRebalance = true;
            message = ` **比例警告** ${assetAName} 佔比嚴重不足 (${assetAPct.toFixed(2)}% < ${minA}%)，建議立即再平衡。`;
            statusBox.className = "status-box status-warn";
        } else {
            message = " **比例健康** 投資組合比例在設定容忍度範圍內。";
            statusBox.className = "status-box status-ok";
        }
        
        statusBox.innerHTML = message.trim(); 

        // --- 傳統再平衡建議 ---
        if (needsRebalance) {
            actionSteps.style.display = "block";
            
            const targetA = totalVal * (targetA_pct / 100);
            const diffA = targetA - assetAVal; 
            const diffB = -diffA; 
            
            const buyColor = 'var(--highlight-color)'; 
            const sellColor = 'var(--status-warn-border)'; 

            // 輸出結果格式：數值在前，K 美元在後
            const assetAAct = diffA > 0 ? `<span style="color:${buyColor}; font-weight: 700;">買入 ${Math.abs(diffA).toFixed(2)} K USD</span>` : `<span style="color:${sellColor}; font-weight: 700;">賣出 ${Math.abs(diffA).toFixed(2)} K USD</span>`;
            const assetBAct = diffB > 0 ? `<span style="color:${buyColor}; font-weight: 700;">買入 ${Math.abs(diffB).toFixed(2)} K USD</span>` : `<span style="color:${sellColor}; font-weight: 700;">賣出 ${Math.abs(diffB).toFixed(2)} K USD</span>`;

            actionSteps.innerHTML = `
                <strong>【再平衡操作】</strong><br>
                為咗達到 ${targetA_pct}/${targetB_pct} 比例，你需要執行以下倉位調整：<br>
                1. ${assetAName}: ${assetAAct}<br>
                2. ${assetBName}: ${assetBAct}
                `;
        } else {
            actionSteps.style.display = "none";
        }

        // --- 月供分配建議 ---
        let dcaMsg = "";

        if (dcaAmount > 0) {
            if (needsRebalance) {
                let underWeightAsset = (assetAPct < targetA_pct) ? assetAName : assetBName;
                
                dcaMsg = `
                    <strong>【月供建議 - 修正】</strong><br>
                    由於倉位嚴重偏離目標，建議將 **100%** (${dcaAmount.toFixed(2)} K USD) 的月供全部投入：
                    <br> ➡️ **${underWeightAsset}**
                    <br><small style="color:var(--text-secondary);">（修正目標：利用新資金逐步調整，直至整體比例回到 ${targetA_pct}/${targetB_pct} 範圍為止。）</small>
                `;
            } else {
                const dcaA = dcaAmount * (targetA_pct / 100);
                const dcaB = dcaAmount * (targetB_pct / 100);
                dcaMsg = `
                    <strong>【月供建議 - 正常】</strong><br>
                    目前嘅倉位比例健康，建議月供按目標 ${targetA_pct}/${targetB_pct} 比例分配：
                    <br> ➡️ ${assetAName} ${targetA_pct}% (${dcaA.toFixed(2)} K USD)
                    <br> ➡️ ${assetBName} ${targetB_pct}% (${dcaB.toFixed(2)} K USD)
                `;
            }
        } else {
            dcaAdvice.className = "dca-advice status-ok";
            dcaMsg = "請設定每月供款金額 (K 美元) 以獲取月供分配建議。";
        }

        dcaAdvice.innerHTML = dcaMsg;
    }
</script>

</body>
</html>
