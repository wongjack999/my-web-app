<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Rebalance - App Flow</title>
    <style>
        /* ****** 輕柔 Neumorphism 變量 (保持不變) ****** */
        :root {
            --bg-color: #ECF0F3; 
            --main-color: #ECF0F3; 
            --text-primary: #333333;
            --text-secondary: #9AA4AE;
            --highlight-color: #635AF0; 
            --highlight-light: #9A87FF; 
            --highlight-text: #FFFFFF;
            --shadow-light: 10px 10px 20px rgba(174, 174, 192, 0.4), -10px -10px 20px #FFFFFF;
            --shadow-small: 5px 5px 10px rgba(174, 174, 192, 0.3), -5px -5px 10px #FFFFFF;
            --inner-shadow-light: inset 5px 5px 10px rgba(174, 174, 192, 0.4), inset -5px -5px 10px #FFFFFF;
            --thumb-shadow: 0 5px 15px rgba(174, 174, 192, 0.6), -5px -5px 10px #FFFFFF; 
            --screen-bg: #F0F4F7; 
            --screen-text: var(--highlight-color); 
            --screen-label: var(--text-secondary); 
            --btn-control-color: var(--main-color);
            --btn-calc-color: var(--highlight-color); 
            --btn-calc-shadow: 0 5px 15px rgba(76, 114, 176, 0.4); 
            --active-color: var(--highlight-light); 
            --status-ok-border: var(--highlight-color);
            --status-warn-border: #CC0000;
            --action-border: #9AA4AE;
            --dca-border: var(--highlight-color);
            --slider-thumb-size: 24px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); 
            display: flex;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 0;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            background: var(--main-color);
            padding: 15px 25px 40px;
            border-radius: 30px; 
            box-shadow: var(--shadow-light); 
            width: 95%;
            max-width: 400px;
            box-sizing: border-box;
            z-index: 1;
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text-primary);
            text-align: center;
        }

        /* ------------------------------------- */
        /* 頁面切換效果 (App-like) */
        /* ------------------------------------- */
        .step-panel {
            /* 保持容器隱藏/顯示的樣式 */
            transition: opacity 0.3s ease, transform 0.3s ease;
            width: 100%;
        }

        /* 初始狀態，結果頁隱藏 */
        .step-panel-hidden {
            display: none;
            opacity: 0;
            transform: translateX(100%); /* 模擬向右滑出/隱藏 */
            position: absolute; 
            top: 0; 
            left: 0;
            padding: inherit;
        }
        
        .step-panel-visible {
            display: block;
            opacity: 1;
            transform: translateX(0);
            position: relative;
        }
        
        /* 覆蓋容器，確保 Step 2 隱藏時不會干擾 Step 1 佈局 */
        .container {
            position: relative; 
            min-height: 600px; /* 設置最小高度以防止跳動 */
        }
        
        /* ------------------------------------- */
        /* 頂部顯示器 (保持不變) */
        /* ------------------------------------- */
        .screen-display {
            background-color: var(--screen-bg);
            color: var(--screen-text);
            padding: 20px 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: var(--inner-shadow-light);
            font-family: sans-serif;
            text-align: center;
            border: none;
        }
        .screen-display .main-value {
            font-size: 2.8rem;
            font-weight: 700;
            line-height: 1.1;
            margin: 0 0 5px 0;
            color: var(--screen-text);
        }
        .screen-display .label {
            font-size: 0.85rem;
            color: var(--screen-label);
            display: block;
            margin-bottom: 15px;
        }
        .screen-display .sub-info {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--screen-label);
            font-weight: 500;
        }
        .screen-display .percentage {
             font-size: 1.2rem;
             color: var(--screen-text);
             font-weight: 700;
        }

        /* ------------------------------------- */
        /* 輸入控制項 (保持不變) */
        /* ------------------------------------- */
        .input-item label, .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        
        .asset-input {
            border-radius: 15px;
            box-shadow: var(--inner-shadow-light);
            background-color: var(--screen-bg);
            height: 50px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            overflow: hidden;
        }
        
        .asset-input input {
            padding: 12px 15px;
            border: none;
            background: none;
            color: var(--text-primary);
            outline: none;
            box-shadow: none;
            margin-bottom: 0;
            height: 100%;
            text-align: center;
        }

        .asset-input input[type="text"] {
            width: 50%;
            font-size: 1.05rem;
            border-right: 1px solid #D9DEE3;
            font-weight: 600;
        }

        .asset-input input[type="number"] {
            width: 50%;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--highlight-color);
        }
        
        .slider-group {
            margin-bottom: 25px;
            text-align: center;
        }

        .dca-value-display {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--highlight-color);
            margin-bottom: 15px;
            display: block;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px; 
            background: transparent;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 10px;
            border-radius: 5px;
            background: var(--main-color);
            box-shadow: var(--inner-shadow-light); 
            border: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: var(--slider-thumb-size);
            width: var(--slider-thumb-size);
            border-radius: 50%;
            background: var(--main-color); 
            margin-top: calc((var(--slider-thumb-size) - 10px) / -2); 
            box-shadow: var(--thumb-shadow); 
            cursor: pointer;
            transition: all 0.2s ease;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            box-shadow: var(--inner-shadow-light); 
            transform: scale(0.95);
        }
        
        .config-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            margin-bottom: 30px;
        }
        .config-buttons button {
            padding: 15px 10px;
            border: none;
            border-radius: 20px; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease; 
            color: var(--text-primary);
            background: var(--btn-control-color); 
            box-shadow: var(--shadow-small);
            border: none;
        }
        .config-buttons button.active {
            background-color: var(--active-color);
            color: var(--highlight-text);
            box-shadow: var(--inner-shadow-light); 
            transform: scale(0.98);
        }
        
        /* ------------------------------------- */
        /* 導航按鈕 (下一步/返回) */
        /* ------------------------------------- */
        .navigation-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .navigation-buttons button {
            padding: 20px;
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            flex-grow: 1; 
        }

        #next-step-btn {
            background-color: var(--btn-calc-color);
            color: var(--highlight-text);
            box-shadow: var(--btn-calc-shadow);
        }
        #next-step-btn:active {
            box-shadow: inset 3px 3px 7px rgba(0, 0, 0, 0.3), inset -3px -3px 7px var(--highlight-light);
            transform: translateY(1px);
        }

        #reset-btn {
            background-color: var(--btn-control-color);
            color: var(--text-primary);
            box-shadow: var(--shadow-small);
            flex-grow: 0;
            min-width: 100px;
        }
        #reset-btn:active {
            box-shadow: var(--inner-shadow-light); 
            transform: scale(0.98);
        }


        /* ------------------------------------- */
        /* 結果展示 (保持不變) */
        /* ------------------------------------- */
        .summary-table {
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%;
            border-radius: 20px;
            box-shadow: var(--shadow-small);
            background-color: var(--main-color);
            overflow: hidden; 
            margin-bottom: 20px;
        }
        .summary-table th, .summary-table td {
            text-align: left;
            padding: 15px;
            font-size: 0.95rem;
            background-color: var(--main-color);
            border-bottom: 1px solid #D9DEE3; 
        }
        
        .summary-table th {
            background-color: var(--screen-bg);
            color: var(--text-primary);
            font-weight: 600;
        }

        .summary-table thead tr:first-child th:first-child { border-top-left-radius: 20px; }
        .summary-table thead tr:first-child th:last-child { border-top-right-radius: 20px; }
        .summary-table tbody tr:last-child td { border-bottom: none; }
        .summary-table tbody tr:last-child td:first-child { border-bottom-left-radius: 20px; }
        .summary-table tbody tr:last-child td:last-child { border-bottom-right-radius: 20px; }
        
        .status-box, .action-steps, .dca-advice {
            border-radius: 15px;
            margin-top: 15px;
            padding: 18px;
            font-weight: 500;
            background-color: var(--main-color);
            box-shadow: var(--shadow-small); 
            border: none;
            font-size: 0.95rem;
        }
        .status-box strong, .dca-advice strong {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .status-ok { border-left: 6px solid var(--status-ok-border); }
        .status-warn { 
            color: var(--status-warn-border);
            border-left: 6px solid var(--status-warn-border); 
        }
        .action-steps { border-left: 6px solid var(--action-border); }
        .dca-advice { border-left: 6px solid var(--dca-border); }
    </style>
</head>
<body>

<div class="container">
    <h2 id="pageTitle">投資組合再平衡 (步驟 1/2)</h2>
    
    <div id="step-1-input" class="step-panel step-panel-visible">
        
        <div id="top-display" class="screen-display">
            <span class="label">當前總資產 (K 美元)</span>
            <div class="main-value" id="resTotalDisplay">0.00</div>
            <div class="sub-info">
                <span>核心資產 (<span id="resAssetNameA_short">A</span>) 比例:</span> 
                <span class="percentage" id="resAssetAPctDisplay">0.00%</span>
            </div>
        </div>

        <div class="input-group">
            <label>設定目標比例 (核心 / 衛星)</label>
            <div class="config-buttons">
                <button id="btn-80-20" onclick="setTarget(80, 20);">80% / 20%</button>
                <button id="btn-70-30" onclick="setTarget(70, 30);">70% / 30%</button>
                <button id="btn-60-40" onclick="setTarget(60, 40);">60% / 40%</button>
                <button id="btn-50-50" onclick="setTarget(50, 50);">50% / 50%</button>
            </div>
        </div>
        
        <div class="input-item">
            <label for="assetAName">核心資產名稱與市值 (K 美元)</label>
            <div class="asset-input">
                <input type="text" id="assetAName" value="QQQ" placeholder="資產代號" oninput="updateInputs()">
                <input type="number" id="assetAVal" value="8.50" placeholder="市值" oninput="updateInputs()">
            </div>
        </div>

        <div class="input-item">
            <label for="assetBName">衛星資產名稱與市值 (K 美元)</label>
            <div class="asset-input">
                <input type="text" id="assetBName" value="BND" placeholder="資產代號" oninput="updateInputs()">
                <input type="number" id="assetBVal" value="1.50" placeholder="市值" oninput="updateInputs()">
            </div>
        </div>

        <div class="input-group slider-group">
            <label for="dcaAmountSlider">每月供款金額 (K 美元)</label>
            <span id="dcaAmountDisplay" class="dca-value-display">0.50 K USD</span> 
            <input 
                type="range" 
                id="dcaAmountSlider" 
                min="0" 
                max="10" 
                step="0.05" 
                value="0.50" 
                oninput="updateDCA(this.value);"
            >
        </div>
        
        <div class="navigation-buttons">
            <button id="next-step-btn" onclick="calculateAndGoToStep2()">下一頁 (評估)</button>
        </div>
    </div>

    <div id="step-2-result" class="step-panel step-panel-hidden">
        <h3 style="font-size: 1.3rem; margin-top: 0; color: var(--text-primary);">組合狀況概要</h3>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>資產</th>
                    <th>市值 (K 美元)</th>
                    <th>比例</th>
                    <th>目標比例</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="resAssetNameA">QQQ</td>
                    <td id="resAssetAVal">-</td>
                    <td id="resAssetAPct">-</td>
                    <td id="resTargetA">80%</td>
                </tr>
                <tr>
                    <td id="resAssetNameB">BND</td>
                    <td id="resAssetBVal">-</td>
                    <td id="resAssetBPct">-</td>
                    <td id="resTargetB">20%</td>
                </tr>
                <tr>
                    <td style="font-weight: 700;">總值</td>
                    <td id="resTotal" colspan="3" style="font-weight: 700;">-</td>
                </tr>
            </tbody>
        </table>

        <div id="statusBox" class="status-box"></div>
        <div id="actionSteps" class="action-steps" style="display:none;"></div>
        <div id="dcaAdvice" class="dca-advice"></div>
        
        <div class="navigation-buttons">
            <button id="reset-btn" onclick="goToStep(1)">返回重置</button>
        </div>
    </div>
    
</div>

<script>
    let targetA_pct = 80;
    let targetB_pct = 20;
    const REBALANCE_TOLERANCE = 5; 

    // --- 流程控制函數 ---
    function goToStep(stepNum) {
        const step1 = document.getElementById('step-1-input');
        const step2 = document.getElementById('step-2-result');
        const title = document.getElementById('pageTitle');
        const container = document.querySelector('.container');

        if (stepNum === 1) {
            // 轉到 Step 1: 輸入頁
            title.innerText = '投資組合再平衡 (步驟 1/2)';
            step2.classList.remove('step-panel-visible');
            step2.classList.add('step-panel-hidden');
            
            // 使用 setTimeout 確保動畫先完成再切換顯示
            setTimeout(() => {
                step1.classList.remove('step-panel-hidden');
                step1.classList.add('step-panel-visible');
            }, 50); // 短暫延遲
            
        } else if (stepNum === 2) {
             // 轉到 Step 2: 結果頁
            title.innerText = '評估結果 (步驟 2/2)';
            step1.classList.remove('step-panel-visible');
            step1.classList.add('step-panel-hidden');
            
            setTimeout(() => {
                step2.classList.remove('step-panel-hidden');
                step2.classList.add('step-panel-visible');
            }, 50); 
        }
        // 確保視圖捲動到頂部
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // --- 輸入/顯示更新函數 ---
    function updateInputs() {
        const assetAName = document.getElementById('assetAName').value.toUpperCase().trim() || 'Asset A';
        const assetAVal = parseFloat(document.getElementById('assetAVal').value) || 0;
        const assetBVal = parseFloat(document.getElementById('assetBVal').value) || 0;
        const totalVal = assetAVal + assetBVal;
        const assetAPct = (totalVal > 0) ? (assetAVal / totalVal) * 100 : 0;

        // 更新頂部顯示與標籤 (Step 1)
        document.getElementById('resAssetNameA_short').innerText = assetAName;
        document.getElementById('resTotalDisplay').innerText = totalVal.toFixed(2);
        document.getElementById('resAssetAPctDisplay').innerText = `${assetAPct.toFixed(2)}%`;
    }

    // 滑桿數值實時更新
    function updateDCA(value) {
        document.getElementById('dcaAmountDisplay').innerText = `${parseFloat(value).toFixed(2)} K USD`;
    }

    // 目標比例設置
    function setTarget(A, B) {
        targetA_pct = A;
        targetB_pct = B;
        
        // 更新按鈕樣式
        document.getElementById('btn-80-20').classList.toggle('active', A === 80);
        document.getElementById('btn-70-30').classList.toggle('active', A === 70);
        document.getElementById('btn-60-40').classList.toggle('active', A === 60);
        document.getElementById('btn-50-50').classList.toggle('active', A === 50);

        // 更新結果頁的目標比例 (預先設置)
        document.getElementById('resTargetA').innerText = `${targetA_pct}%`;
        document.getElementById('resTargetB').innerText = `${targetB_pct}%`;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // 初始化狀態
        setTarget(80, 20); 
        const initialDCA = document.getElementById('dcaAmountSlider').value;
        updateDCA(initialDCA); 
        updateInputs(); // 載入時更新頂部顯示
        goToStep(1); // 確保從 Step 1 開始
    });


    // --- 主要計算與跳轉函數 ---
    function calculateAndGoToStep2() {
        const assetAName = document.getElementById('assetAName').value.toUpperCase().trim() || 'Asset A';
        const assetBName = document.getElementById('assetBName').value.toUpperCase().trim() || 'Asset B';
        
        const assetAVal = parseFloat(document.getElementById('assetAVal').value) || 0;
        const assetBVal = parseFloat(document.getElementById('assetBVal').value) || 0;
        const dcaAmount = parseFloat(document.getElementById('dcaAmountSlider').value) || 0;
        
        const totalVal = assetAVal + assetBVal;

        // 驗證輸入
        if (totalVal <= 0) {
            alert("請輸入有效的資產市值 (K USD)！");
            return;
        }

        const minA = targetA_pct - REBALANCE_TOLERANCE;
        const maxA = targetA_pct + REBALANCE_TOLERANCE;
        const assetAPct = (assetAVal / totalVal) * 100;
        const assetBPct = 100 - assetAPct;
        
        // --- 1. 更新 Step 2 結果欄位 ---
        document.getElementById('resAssetNameA').innerText = assetAName;
        document.getElementById('resAssetNameB').innerText = assetBName;
        document.getElementById('resAssetAVal').innerText = `${assetAVal.toFixed(2)} K USD`;
        document.getElementById('resAssetAPct').innerText = `${assetAPct.toFixed(2)}%`;
        document.getElementById('resAssetBVal').innerText = `${assetBVal.toFixed(2)} K USD`;
        document.getElementById('resAssetBPct').innerText = `${assetBPct.toFixed(2)}%`;
        document.getElementById('resTotal').innerText = `${totalVal.toFixed(2)} K USD`;
        
        // --- 2. 處理狀態與建議 ---
        const statusBox = document.getElementById('statusBox');
        const actionSteps = document.getElementById('actionSteps');
        const dcaAdvice = document.getElementById('dcaAdvice');
        
        let needsRebalance = false;
        let message = "";
        
        if (assetAPct > maxA || assetAPct < minA) {
            needsRebalance = true;
            let condition = (assetAPct > maxA) ? `過高 (${assetAPct.toFixed(2)}% > ${maxA}%)` : `不足 (${assetAPct.toFixed(2)}% < ${minA}%)`;
            message = ` **比例警告** ${assetAName} 佔比嚴重${condition}，建議立即再平衡。`;
            statusBox.className = "status-box status-warn";
        } else {
            message = " **比例健康** 投資組合比例在設定容忍度範圍內。";
            statusBox.className = "status-box status-ok";
        }
        
        statusBox.innerHTML = `<strong>${message.trim()}</strong>`; 

        // 傳統再平衡建議
        if (needsRebalance) {
            actionSteps.style.display = "block";
            const targetA = totalVal * (targetA_pct / 100);
            const diffA = targetA - assetAVal; 
            const diffB = -diffA; 
            const buyColor = 'var(--highlight-color)'; 
            const sellColor = 'var(--status-warn-border)'; 

            const assetAAct = diffA > 0 ? `<span style="color:${buyColor}; font-weight: 700;">買入 ${Math.abs(diffA).toFixed(2)} K USD</span>` : `<span style="color:${sellColor}; font-weight: 700;">賣出 ${Math.abs(diffA).toFixed(2)} K USD</span>`;
            const assetBAct = diffB > 0 ? `<span style="color:${buyColor}; font-weight: 700;">買入 ${Math.abs(diffB).toFixed(2)} K USD</span>` : `<span style="color:${sellColor}; font-weight: 700;">賣出 ${Math.abs(diffB).toFixed(2)} K USD</span>`;

            actionSteps.innerHTML = `
                <strong>【再平衡操作】</strong><br>
                為咗達到 ${targetA_pct}/${targetB_pct} 比例，你需要執行以下倉位調整：<br>
                1. ${assetAName}: ${assetAAct}<br>
                2. ${assetBName}: ${assetBAct}
                `;
        } else {
            actionSteps.style.display = "none";
        }

        // 月供分配建議
        let dcaMsg = "";
        if (dcaAmount > 0) {
            if (needsRebalance) {
                let underWeightAsset = (assetAPct < targetA_pct) ? assetAName : assetBName;
                dcaAdvice.className = "dca-advice status-warn"; 
                dcaMsg = `
                    <strong>【月供建議 - 修正】</strong><br>
                    由於倉位嚴重偏離目標，建議將 **100%** (${dcaAmount.toFixed(2)} K USD) 的月供全部投入：
                    <br> ➡️ **${underWeightAsset}**
                    <br><small style="color:var(--text-secondary);">（修正目標：利用新資金逐步調整，直至整體比例回到 ${targetA_pct}/${targetB_pct} 範圍為止。）</small>
                `;
            } else {
                const dcaA = dcaAmount * (targetA_pct / 100);
                const dcaB = dcaAmount * (targetB_pct / 100);
                dcaAdvice.className = "dca-advice status-ok"; 
                dcaMsg = `
                    <strong>【月供建議 - 正常】</strong><br>
                    目前嘅倉位比例健康，建議月供按目標 ${targetA_pct}/${targetB_pct} 比例分配：
                    <br> ➡️ ${assetAName} ${targetA_pct}% (${dcaA.toFixed(2)} K USD)
                    <br> ➡️ ${assetBName} ${targetB_pct}% (${dcaB.toFixed(2)} K USD)
                `;
            }
        } else {
            dcaAdvice.className = "dca-advice status-ok";
            dcaMsg = "請設定每月供款金額 (K 美元) 以獲取月供分配建議。";
        }
        dcaAdvice.innerHTML = dcaMsg;

        // --- 3. 跳轉到 Step 2 ---
        goToStep(2);
    }
</script>

</body>
</html>
